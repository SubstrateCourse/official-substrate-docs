
# Architecture and Rust libraries

正如区块链基础知识中所述，区块链依赖于一个分散的计算机网络，称为节点，这是任何区块链的核心组件。因为节点是任何区块链的核心组件，所以了解什么使 Substrate 节点独特，包括默认提供的核心服务和库以及如何自定义和扩展节点以适应不同的项目目标是很重要的。


## Client and runtime

在高层次上，Substrate 节点由两个主要部分组成：

- 核心客户端和外部节点服务，处理网络活动，例如对等体发现、管理交易请求、与对等体达成共识以及响应 RPC 调用。 
- 运行时包含执行区块链状态转换函数的所有业务逻辑。 

以下图表以简化形式说明了这种职责分离，以帮助您可视化架构以及 Substrate 提供的用于构建区块链的模块化框架。

![](https://docs.substrate.io/static/ba5a48a1993a5eddabf1e91c3eb9974f/3cc59/simplified-architecture.webp)

## Client outer node services

核心客户端包括多个外部节点服务，负责处理运行时之外的活动。例如，核心客户端中的外部节点服务处理对等体发现、管理交易池、与其他节点通信以达成共识，并响应来自外部世界的 RPC 请求。

一些最重要的由核心客户端服务处理的活动涉及以下组件：

- 存储：外部节点使用简单且高效的键值存储层持久化 Substrate 区块链的演变状态。 
- 点对点网络：外部节点使用 Rust 实现的 libp2p 网络堆栈与其他网络参与者通信。 
- 共识：外部节点与其他网络参与者通信，以确保他们对区块链的状态达成一致。 
- 远程过程调用（RPC）API：外部节点接受入站 HTTP 和 WebSocket 请求，以允许区块链用户与网络交互。 
- 遥测：外部节点通过嵌入式 Prometheus 服务器收集并提供对节点指标的访问。 
- 执行环境：外部节点负责选择运行时使用的执行环境（WebAssembly 或本机 Rust），然后将调用分派到所选运行时。

Substrate 通过其核心区块链组件提供了处理这些活动的默认实现。原则上，您可以修改或替换任何组件的默认实现为自己的代码。实际上，很少有应用程序需要更改任何底层区块链功能，但 Substrate 允许您进行更改，以便您可以自由创新。

执行这些任务通常需要客户端节点服务与运行时通信。这种通信通过调用专门的运行时 API 处理。

## Runtime

运行时确定交易的有效性或无效性，并负责处理区块链状态的更改。来自外部的请求通过客户端进入运行时，运行时负责状态转换函数和存储生成的状态。

由于运行时执行其接收到的函数，因此它控制着如何将交易包含在块中以及如何将块返回给外部节点进行八卦或导入到其他节点。实质上，运行时负责处理发生在链上的所有事情。它也是构建 Substrate 区块链的节点的核心组件。

Substrate 运行时旨在编译为 WebAssembly（Wasm）字节码。这种设计决策使得：

- 支持无分叉升级。 
- 多平台兼容性。 
- 运行时有效性检查。 
- 中继链共识机制的验证证明。 

与外部节点提供信息给运行时的方式类似，运行时使用专门的主机函数与外部节点或外部世界通信。

## Core libraries

为了保持节点模板的简单性，区块链的许多方面都使用默认实现进行配置。例如，有默认的网络层、数据库和共识机制实现，您可以直接使用它们来运行区块链，而无需进行大量自定义。但是，基本架构的底层库提供了很大的灵活性，可以定义自己的区块链组件。

就像节点由两个主要部分——提供不同服务的核心客户端和运行时——组成一样，Substrate 库分为三个主要责任领域：

外部节点服务的核心客户端库。 运行时的 FRAME 库。 用于底层功能和接口的原始库，用于库之间的通信。 以下图表说明了库如何反映核心客户端外部节点和运行时职责以及原语库如何提供两者之间的通信层。

![](https://docs.substrate.io/static/dae77f7ece855ad265b5c93651f4881b/b0783/libraries.webp)

### Core client libraries

使 Substrate 节点能够处理其网络职责（包括共识和块执行）的库是使用 sc_ 前缀的 Rust crate。例如，sc_service 库负责为 Substrate 区块链构建网络层，管理网络参与者和交易池之间的通信。

### FRAME libraries for the runtime

您可以使用带有 frame_ 前缀的 Rust crates 来构建运行时逻辑并对传入和传出运行时的信息进行编码和解码。

frame_* 库提供了运行时的基础设施。例如，frame_system 库提供了一组基本函数，用于与其他 Substrate 组件交互，而 frame_support 则使您能够声明运行时存储项、错误和事件。

除了 frame_* 库提供的基础设施外，运行时还可以包括一个或多个 pallet_* 库。每个使用 pallet_ 前缀的 Rust crate 都代表一个单独的 FRAME 模块。在大多数情况下，您使用 pallet_* 库来组装您希望在区块链中包含的功能，以适应您的项目。

您可以使用 primitives 库而不使用 frame_* 或 pallet_* 库来构建 Substrate 运行时。但是，frame_* 或 pallet_* 库提供了组成 Substrate 运行时的最有效路径。


### Primitive libraries


在 Substrate 架构的最底层，有原始库，它们使您能够控制底层操作并在核心客户端服务和运行时之间进行通信。原始库是使用 sp_ 前缀的 Rust crates。

原始库提供了最低级别的抽象，以暴露核心客户端或运行时可以用来执行操作或相互交互的接口。

例如：

- sp_arithmetic 库定义了运行时可用的定点算术原语和类型。 
- sp_core 库提供了一组可共享的 Substrate 类型。 
- sp_std 库从 Rust 标准库中导出原语，使它们可用于任何依赖于运行时的代码。

## Modular architecture

Substrate 核心库的分离提供了一个灵活且模块化的架构，用于编写区块链逻辑。原始库为核心客户端和运行时提供了一个基础，它们可以在不直接相互通信的情况下构建。原始类型和特征在它们自己的单独 crates 中暴露，因此它们可以在不引入循环依赖问题的情况下提供给外部节点服务和运行时组件。

## Where to go next

现在您已经熟悉了用于构建和与 Substrate 节点交互的架构和库，您可能希望更深入地探索这些库。要了解任何库的技术细节，您应该查看该库的 Rust API 文档。














